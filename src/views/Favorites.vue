<template>
  <v-content>
    <v-container>
      <v-progress-linear v-if="loading" :indeterminate="true"></v-progress-linear>

      <v-card v-else>
        <v-layout row wrap>
          <v-flex xs12 pb-0>
            <h5 class="headline font-weight-light pa-3">Favoritos</h5>
          </v-flex>
          <v-container class="pa-0 ma-0 line-wrap">
            <v-layout wrap class="pa-0 ma-0">
              <v-flex xs12 md12 lg12 xl12 class="pa-0">
                <v-list>
                  <v-list-tile class="line py-2">
                    <v-list-tile-action>
                      <v-checkbox></v-checkbox>
                    </v-list-tile-action>

                    <v-list-tile-content>
                      <v-list-tile-title>Todos ({{this.articles.length}})</v-list-tile-title>
                    </v-list-tile-content>
                  </v-list-tile>

                  <v-list-tile
                    v-for="article in articles"
                    :key="article.id"
                    avatar
                    class="line border"
                    >

                    <v-list-tile-action>
                      <v-checkbox></v-checkbox>
                    </v-list-tile-action>

                    <v-list-tile-avatar :tile="false" size="150">
                      <img :src="getImage(article)">
                    </v-list-tile-avatar>

                    <v-list-tile-content class="ml-4 article-caption">
                      <v-list-tile-title class="title font-weight-light mb-2">{{ article.title }}</v-list-tile-title>
                      <v-list-tile-sub-title class="title font-weight-light">{{ article.price | priceFilter }}</v-list-tile-sub-title>
                    </v-list-tile-content>

                    <v-tooltip bottom max-width="25rem">
                      <template slot="activator">
                        <v-list-tile-action>
                          <v-btn icon ripple :href="article.permalink" target="_blank">
                            <v-icon color="grey lighten-1">call_made</v-icon>
                          </v-btn>
                        </v-list-tile-action>
                      </template>
                        <span>Ver en Mercado Libre</span>
                    </v-tooltip>

                    <v-tooltip bottom max-width="25rem">
                      <template slot="activator">
                        <v-list-tile-action>
                          <v-btn icon ripple :to="`/articulo/${article.id}`">
                            <v-icon color="grey lighten-1">show_chart</v-icon>
                          </v-btn>
                        </v-list-tile-action>
                      </template>
                        <span>Ver art√≠culo</span>
                    </v-tooltip>

                    <v-tooltip bottom max-width="25rem">
                      <template slot="activator">
                        <v-list-tile-action>
                          <v-btn icon ripple>
                            <v-icon color="grey lighten-1">more_vert</v-icon>
                          </v-btn>
                        </v-list-tile-action>
                      </template>
                        <span>Opciones</span>
                    </v-tooltip>
                  </v-list-tile>
                </v-list>
              </v-flex>
            </v-layout>
          </v-container>
        </v-layout>
      </v-card>
    </v-container>
  </v-content>
</template>

<script>
import { mapGetters } from 'vuex'
import api from '../api'

export default {
  data: () => ({
    loading: true,
    articles: []
  }),
  computed: {
    ...mapGetters({
      authenticating: 'auth/authenticating',
      isAuthenticated: 'auth/isAuthenticated',
      favorites: 'auth/favorites',
    })
  },
  methods: {
    getImage (article) {
      const [image] = article.images
      return image
    }
  },
  mounted () {
    const interval = setInterval(async () => {
      if (!this.authenticating) {
        if (!this.isAuthenticated) {
          this.$router.push('/')
        }
        clearInterval(interval)
        // TODO: refactor this from the BE so we only do 1 paginated request
        this.articles = await Promise.all(
          this.favorites.map(async (id) => {
            const { data } = await api.getArticle(id)
            return data
          })
        )
        this.loading = false
      }
    }, 100)
  }
}
</script>

<style scoped>
.border {
  border-top: 1px solid rgba(0,0,0,.12);
}

.line {
  min-height: auto;
  padding: 5rem 1rem;
}

.article-caption {
  min-height: 50px;
}
</style>
